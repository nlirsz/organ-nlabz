name: Build and Deploy to Netlify

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
      NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Build (Vite)
        run: npm run build:netlify

      - name: Save build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist

      - name: Trigger Netlify deploy via API
        if: ${{ env.NETLIFY_AUTH_TOKEN != '' && env.NETLIFY_SITE_ID != '' }}
        run: |
          echo "Triggering Netlify build for site $NETLIFY_SITE_ID"
          curl -s -X POST "https://api.netlify.com/api/v1/sites/${NETLIFY_SITE_ID}/builds" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${NETLIFY_AUTH_TOKEN}" \
            -d '{"clear_cache": true}' | jq -r

      - name: Show note if Netlify secrets missing
        if: ${{ env.NETLIFY_AUTH_TOKEN == '' || env.NETLIFY_SITE_ID == '' }}
        run: |
          echo "NETLIFY_AUTH_TOKEN or NETLIFY_SITE_ID not configured as repo secrets." 
          echo "Add them in Settings → Secrets → Actions and re-run this workflow, or provide a Deploy Hook URL instead."
